// Generated by CoffeeScript 1.6.3
(function() {
  $(document).ready(function() {
    var attach_resource, create_editor, detach_resource, div, editing_space, editor_template, field_list, header_template, icon, input, label, model_field_url, renderable, span, strong, text, url_join, webview_id;
    renderable = teacup.renderable;
    div = teacup.div;
    icon = teacup.i;
    strong = teacup.strong;
    span = teacup.span;
    label = teacup.label;
    input = teacup.input;
    text = teacup.text;
    url_join = TrumpetApp.functions.url_join;
    editing_space = $('.editing-space');
    field_list = $('.field-list');
    webview_id = $('input[name=webview_id]').val();
    model_field_url = function(model_id, field_id) {
      var url;
      url = url_join('/rest/admin/layoutmodels', model_id, 'fields', field_id);
      return url;
    };
    header_template = renderable(function(content) {
      return div('.btn.btn-default.btn-xs', function() {
        return text(content);
      });
    });
    editor_template = renderable(function() {
      div('#edit-status.listview-header', function() {
        text('Editing template');
        div('#save-content.action-button', function() {
          return text('Save');
        });
        div('#keybinding.action-button', function() {
          return text('emacs');
        });
        return div('#cancel-button.action-button.pull-right', function() {
          return text('Cancel');
        });
      });
      return div('#editor');
    });
    create_editor = function(webview_id) {
      var button, cancel_button, content_callback, editor, fresh_edit, html, response, save_button, save_edit_error, session, togglefun, url;
      html = editor_template;
      editing_space.html(html);
      editing_space.show();
      save_button = $('#save-content');
      save_button.hide();
      cancel_button = $('#cancel-button');
      cancel_button.click(function() {
        return window.location.reload();
      });
      editor = ace.edit('editor');
      TrumpetApp.editor = editor;
      session = editor.getSession();
      session.on('change', function() {
        return save_button.show();
      });
      session.setMode('ace/mode/coffee');
      session.setTabSize(4);
      editor.setTheme('ace/theme/trumpet');
      editor.setKeyboardHandler('ace/keyboard/emacs');
      button = $('#keybinding');
      togglefun = TrumpetApp.functions.toggle_ace_keybinding;
      togglefun(button, editor);
      url = url_join('/rest/admin/webviews/', webview_id);
      content_callback = function(data, status, xhr) {
        if (status === 'success') {
          window.rdata = data;
          if (data.template !== null) {
            editor.setValue(data.template.content);
            return save_button.hide();
          }
        }
      };
      response = $.get(url, {}, content_callback);
      fresh_edit = function(data, status, xhr) {
        if (status === 'success') {
          save_button.hide();
        }
        TrumpetApp.rdata = data;
        TrumpetApp.rstatus = status;
        return TrumpetApp.rxhr = xhr;
      };
      save_edit_error = function(data, status, xhr) {
        TrumpetApp.rdata = data;
        TrumpetApp.rstatus = status;
        TrumpetApp.rxhr = xhr;
        return TrumpetApp.make_alert("Error in save");
      };
      return save_button.click(function() {
        var formdata;
        formdata = {
          update: 'submit',
          template: editor.getValue()
        };
        url = url_join('/rest/admin/webviews', webview_id);
        return $.ajax(url, {
          type: 'PUT',
          data: JSON.stringify(formdata),
          success: fresh_edit,
          error: save_edit_error,
          dataType: 'json'
        });
      });
    };
    attach_resource = function(type, id) {
      var attach_success, formdata, url;
      url = url_join('/rest/admin/webview', webview_id, type);
      attach_success = function(data, status, xhr) {
        if (status === 'success') {
          return window.location.reload();
        }
      };
      formdata = {
        update: 'submit'
      };
      if (type === 'css') {
        formdata.css_id = id;
      } else {
        formdata.js_id = id;
      }
      return $.ajax(url, {
        type: 'POST',
        data: JSON.stringify(formdata),
        success: attach_success,
        dataType: 'json'
      });
    };
    detach_resource = function(type, id) {
      var detach_success, url;
      url = url_join('/rest/admin/webview', webview_id, type, id);
      detach_success = function(data, status, xhr) {
        if (status === 'success') {
          return window.location.reload();
        }
      };
      return $.ajax(url, {
        type: 'DELETE',
        data: {},
        success: detach_success,
        dataType: 'json'
      });
    };
    $('.edit-template').click(function() {
      return create_editor(webview_id);
    });
    $('.attach-css').click(function() {
      var id, s, type;
      type = 'css';
      s = $('select[name=css_id]');
      id = s.val();
      return attach_resource(type, id);
    });
    $('.attach-js').click(function() {
      var id, s, type;
      type = 'js';
      s = $('select[name=js_id]');
      id = s.val();
      return attach_resource(type, id);
    });
    $('.detach-css').click(function() {
      var id, type;
      type = 'css';
      id = $(this).attr('data');
      return detach_resource(type, id);
    });
    return $('.detach-js').click(function() {
      var id, type;
      type = 'js';
      id = $(this).attr('data');
      return detach_resource(type, id);
    });
  });

}).call(this);
